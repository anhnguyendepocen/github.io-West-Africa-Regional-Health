
<!DOCTYPE HTML>
<html>
  <head>
    <meta charset="utf-8" />
    <title>Newest USAID GIS Projects</title>
    <link rel="stylesheet" href="http://js.arcgis.com/3.15/dojo/resources/dojo.css">
    <link rel="stylesheet" href="http://js.arcgis.com/3.15/dgrid/css/dgrid.css">
    <link rel="stylesheet" href="http://js.arcgis.com/3.15/dgrid/css/skins/claro.css">
    <link rel="stylesheet" href="http://js.arcgis.com/3.15/dijit/themes/claro/claro.css">
    <link rel="stylesheet" href="http://js.arcgis.com/3.15/esri/css/esri.css">
    <link rel="stylesheet" href="http://developers.arcgis.com/javascript/samples/portal_getgroupamd/css/layout.css">

<style>
a:link {
    color: #002A6C;
}
a:visited {
    color: #002A6C;
}
a:hover {
    color: #C2113A;
}
a:active {
    color: #002A6C;
}
</style>
	
    <script>
      //async is a new dojoConfig option. The default value of false will load all the Dojo base modules
      //here we set it to true to take advantage of the asynchronous nature of dojo and the the base modules
      //are not automatically loaded.
      var dojoConfig = { async: true };
    </script>
    <script src="http://js.arcgis.com/3.15/"></script>
    <script>
    //require function accepts an array of module ids and a function. The modules are provided as return variables passed as arguments to the function. This replaces the dojo.requires statements.
      require([
        "dojo/parser", 
        "dojo/ready", 
        "dojo/dom", 
        "dojo/dom-construct", 
        "dojo/_base/array", 
        "dijit/registry", 
        "dojo/on", 
        "esri/arcgis/Portal", 
        "esri/config",
        "esri/lang",
        "dgrid/Grid", 
        "dijit/layout/BorderContainer", 
        "dijit/layout/ContentPane" 
      ],function(
        parser, 
        ready, 
        dom, 
        domConstruct, 
        array, 
        registry, 
        on, 
        arcgisPortal,
        config, 
        esriLang,
        Grid
      ) {
        var portal, portalUrl, groupGrid;
        
        
        
        var orgCode = "Djjoop3BmZekEtDo";
        var progtype = '("Web Mapping Application" OR "PDF" OR "IMAGE")';
        var sharing = "public";

        //Replaces dojo.ready / dojo.addOnLoad
        ready(function() {
          parser.parse(); //replaces parseOnLoad = true in dojoConfig

          config.defaults.io.proxyUrl = 'http://developers.arcgis.com/javascript/samples/proxy/proxy.ashx';
          portalUrl = document.location.protocol + '//www.arcgis.com';

          //create the portal
          portal = new arcgisPortal.Portal(portalUrl);

          on(portal, 'load', function(p) {
                findArcGISGroup();
          });
        });

        // find groups based on input keyword
        function findArcGISGroup() {
          //var keyword = dom.byId('groupFinder').value;
          var params = {
			q:  'orgid: ' + orgCode + ' AND type:' + progtype + ' AND access:' + sharing,
            sortField:'uploaded',
            sortOrder:'desc',
            num:15 //find 20 items - max is 100
          };
          portal.queryItems(params).then(function (data) {
            showGroupResults(data);
          });
        }


        //display a list of groups that match the input user name
        function showGroupResults(response) {
          //clear any existing results
          var data = [];
            if (groupGrid) {
              groupGrid.refresh();
            }
            if (response.total > 0) {
			//alert(response.total); 
              //create an array of attributes for each group - we'll display these in a dojo dgrid
              data = array.map(response.results, function (group) {
                return {
                  'snippet': group.snippet,
                  'title': group.title,
				  'type': group.type,
				  'created':group.created,
                  'url': group.url,
                  'thumbnail': group.thumbnailUrl || 'http://cdn.arcgis.com/cdn/7674/js/jsapi/esri/css/images/item_type_icons/apps16.png',
                  'id': group.id,
                  'owner': group.owner
                };
              });
              //create the grid
              groupGrid = new Grid({
                columns: {
                  thumbnail: 'Group Icon',
				  type: 'type',
                  title: 'Group',
                  snippet: 'Description',
                  id: 'Group ID'
                },
                renderRow: renderTable,
                //this function renders the table in a non-grid looking view
                showHeader: false
              }, "grid");
              groupGrid.renderArray(data);

            } else {
              dom.byId('groupResults').innerHTML = '<h2>Group Results</h2><p>No groups were found. If the group is not public use the sign-in link to sign in and find private groups.</p>';
            }
          }

          function renderTable(obj, options) {

            var template = '<a target="_blank" class="title" href=${url}>${title}</a><br><span class="owner">${type} by ${owner} <br> ${created} </span><div class="summary">${snippet} </div><hr>';

            //obj.url = portalUrl + '/apps/MapJournal/?appid=' + obj.id;
			if(obj.type == "PDF" || obj.type == "Image"){
			obj.url = "http://usaid.maps.arcgis.com/sharing/rest/content/items/"+obj.id+"/data"; 
			}
            //http://usaid.maps.arcgis.com/apps/MapJournal/?appid=7d94bc889b3c4ff5bc892de734498dd0
            //obj.thumbnail = obj.thumbnail || '';

            //domConstruct.create is a replacement for dojo.create
            return div = domConstruct.create("div",{
              innerHTML : esriLang.substitute(obj,template)
            });

          }

          // gets private groups as well
          function signIn() {
            var signInLink = dom.byId('signIn');

            if (signInLink.innerHTML.indexOf('In') !== -1) {
                portal.signIn().then(function (loggedInUser) {
                    signInLink.innerHTML = "Sign Out";
                    findArcGISGroup();   // update results
                }, function (error) {
                  signInLink.innerHTML = 'Sign In';   //error so reset sign in link
                });
            } else {
              portal.signOut().then(function (portalInfo) {
                signInLink.innerHTML = "Sign In";
                findArcGISGroup();
              });
            }
          }
      });
    </script>
  </head>

  <body class="claro">
    <div data-dojo-type="dijit/layout/BorderContainer" data-dojo-props="design:'headline',gutters:false"
    style="width:100%;height:100%;margin:0;">
      <div data-dojo-type="dijit/layout/ContentPane" data-dojo-props="region:'top'">
        <h1>Newest USAID GIS Projects</h1>
        
      </div>
      <div id='gridpane' data-dojo-type="dijit/layout/ContentPane" data-dojo-props="region:'center'">
        <div id='grid'></div>
        <div id="groupResults"></div>
      </div>
    </div>
  </body>
</html>
